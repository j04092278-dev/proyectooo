<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Carreras 3D Extremo - Joystick</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        body {
            margin: 0;
            padding: 0;
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-family: 'Arial', sans-serif;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
            position: fixed;
        }

        .game-container {
            width: 100%;
            height: 100%;
            position: relative;
            background: #1a1a1a;
        }

        canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: block;
        }

        /* Header */
        .header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: 10px 15px;
            background: linear-gradient(180deg, rgba(0,0,0,0.9) 0%, transparent 100%);
            z-index: 100;
            pointer-events: none;
        }

        h1 {
            color: #ff4444;
            text-shadow: 0 0 10px rgba(255, 68, 68, 0.7);
            font-size: clamp(1.5rem, 4vw, 2.2rem);
            text-align: center;
            margin: 0;
            letter-spacing: 1px;
        }

        /* HUD */
        .hud {
            position: absolute;
            top: 15px;
            left: 15px;
            color: white;
            font-size: clamp(14px, 3vw, 18px);
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            background: rgba(0, 0, 0, 0.5);
            padding: 8px 12px;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.2);
            z-index: 50;
        }

        .hud-item {
            margin: 4px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .hud-icon {
            width: 20px;
            height: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        /* Joystick Circular */
        .joystick-container {
            position: absolute;
            bottom: clamp(20px, 10vh, 100px);
            left: clamp(20px, 5vw, 60px);
            width: clamp(120px, 30vw, 200px);
            height: clamp(120px, 30vw, 200px);
            z-index: 100;
            touch-action: none;
        }

        .joystick-base {
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(0,0,0,0.7) 30%, rgba(50,50,50,0.4) 100%);
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.3);
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            position: relative;
        }

        .joystick-knob {
            position: absolute;
            width: clamp(40px, 10vw, 70px);
            height: clamp(40px, 10vw, 70px);
            background: radial-gradient(circle, #4a6fa5 0%, #2a4a7a 100%);
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.5);
            box-shadow: 0 0 15px rgba(74, 111, 165, 0.5);
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            transition: transform 0.1s;
            cursor: move;
        }

        .joystick-center {
            position: absolute;
            width: 8px;
            height: 8px;
            background: rgba(255,255,255,0.8);
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        /* Botones de acci√≥n */
        .action-buttons {
            position: absolute;
            bottom: clamp(20px, 10vh, 100px);
            right: clamp(20px, 5vw, 60px);
            display: flex;
            flex-direction: column;
            gap: clamp(10px, 3vh, 20px);
            z-index: 100;
        }

        .action-btn {
            width: clamp(70px, 20vw, 120px);
            height: clamp(70px, 20vw, 120px);
            border-radius: 50%;
            border: none;
            background: radial-gradient(circle, rgba(255,68,68,0.9) 0%, rgba(200,0,0,0.9) 100%);
            color: white;
            font-size: clamp(14px, 3vw, 18px);
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            transition: all 0.1s;
            user-select: none;
            touch-action: manipulation;
            text-align: center;
            padding: 10px;
            line-height: 1.2;
        }

        .action-btn:active {
            transform: scale(0.95);
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .turbo-btn {
            background: radial-gradient(circle, rgba(255,215,0,0.9) 0%, rgba(255,140,0,0.9) 100%);
        }

        .turbo-btn:active {
            background: radial-gradient(circle, rgba(255,235,0,0.9) 0%, rgba(255,160,0,0.9) 100%);
        }

        .restart-btn {
            background: radial-gradient(circle, rgba(0,120,255,0.9) 0%, rgba(0,80,200,0.9) 100%);
        }

        /* Indicador de turbo */
        .turbo-indicator {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(0,0,0,0.7);
            padding: 10px;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            font-size: clamp(12px, 2.5vw, 16px);
            z-index: 50;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .turbo-bar {
            width: 100px;
            height: 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .turbo-fill {
            height: 100%;
            background: linear-gradient(90deg, #ffd700, #ff8c00);
            width: 0%;
            transition: width 0.3s;
        }

        /* Game Over Screen */
        .game-over {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 200;
            color: white;
            text-align: center;
            padding: 20px;
        }

        .game-over h2 {
            font-size: clamp(2rem, 6vw, 3.5rem);
            color: #ff4444;
            margin-bottom: 20px;
            text-shadow: 0 0 15px rgba(255,68,68,0.5);
        }

        .game-over p {
            font-size: clamp(1.2rem, 3vw, 1.8rem);
            margin: 10px 0;
        }

        .game-over button {
            margin-top: 30px;
            padding: 15px 40px;
            font-size: clamp(1.2rem, 3vw, 1.5rem);
            background: linear-gradient(135deg, #ff4444, #cc0000);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            transition: all 0.2s;
        }

        .game-over button:active {
            transform: scale(0.95);
        }

        /* Instrucciones */
        .instructions {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            color: rgba(255,255,255,0.7);
            font-size: clamp(10px, 2vw, 12px);
            text-align: center;
            background: rgba(0,0,0,0.5);
            padding: 5px 10px;
            border-radius: 5px;
            z-index: 50;
        }

        /* Ajustes responsivos */
        @media (max-width: 768px) {
            .joystick-container {
                bottom: 80px;
                left: 30px;
            }
            
            .action-buttons {
                bottom: 80px;
                right: 30px;
            }
        }

        @media (max-height: 600px) {
            .joystick-container {
                bottom: 60px;
                width: 100px;
                height: 100px;
            }
            
            .action-buttons {
                bottom: 60px;
            }
            
            .action-btn {
                width: 60px;
                height: 60px;
                font-size: 12px;
            }
        }

        @media (orientation: landscape) and (max-height: 500px) {
            .header h1 {
                font-size: 1.5rem;
            }
            
            .hud {
                top: 5px;
                left: 5px;
                font-size: 12px;
                padding: 5px 8px;
            }
            
            .turbo-indicator {
                top: 5px;
                right: 5px;
                padding: 5px;
                font-size: 12px;
            }
            
            .joystick-container {
                bottom: 40px;
                width: 90px;
                height: 90px;
            }
            
            .action-buttons {
                bottom: 40px;
                gap: 10px;
            }
            
            .action-btn {
                width: 50px;
                height: 50px;
                font-size: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="header">
            <h1>üèÅ CARRERAS 3D EXTREMO üèÅ</h1>
        </div>
        
        <div class="hud">
            <div class="hud-item">
                <div class="hud-icon">üöó</div>
                <span id="speed">0 km/h</span>
            </div>
            <div class="hud-item">
                <div class="hud-icon">‚≠ê</div>
                <span id="score">0 pts</span>
            </div>
            <div class="hud-item">
                <div class="hud-icon">‚ù§Ô∏è</div>
                <span id="lives">3</span>
            </div>
        </div>
        
        <div class="turbo-indicator">
            <div>TURBO</div>
            <div class="turbo-bar">
                <div class="turbo-fill" id="turbo-fill"></div>
            </div>
            <div id="turbo-text">LISTO</div>
        </div>
        
        <!-- Joystick circular -->
        <div class="joystick-container" id="joystick-container">
            <div class="joystick-base">
                <div class="joystick-center"></div>
                <div class="joystick-knob" id="joystick-knob"></div>
            </div>
        </div>
        
        <!-- Botones de acci√≥n -->
        <div class="action-buttons">
            <button class="action-btn turbo-btn" id="turbo-btn">TURBO</button>
            <button class="action-btn restart-btn" id="restart-btn">REINICIAR</button>
        </div>
        
        <!-- Instrucciones -->
        <div class="instructions">
            Mueve el joystick para dirigir ‚Ä¢ Turbo para acelerar
        </div>
        
        <!-- Pantalla de Game Over -->
        <div class="game-over" id="game-over">
            <h2>GAME OVER</h2>
            <p>Puntuaci√≥n final: <span id="final-score">0</span></p>
            <p>R√©cord: <span id="high-score">0</span></p>
            <button id="play-again-btn">JUGAR DE NUEVO</button>
        </div>
        
        <canvas id="gameCanvas"></canvas>
    </div>

    <script>
        // Inicializaci√≥n del canvas
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // Ajustar canvas al tama√±o de la pantalla
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        
        // Inicializar tama√±o
        window.addEventListener('load', resizeCanvas);
        window.addEventListener('resize', resizeCanvas);
        window.addEventListener('orientationchange', resizeCanvas);
        resizeCanvas();

        // Colores del juego
        const COLORS = {
            SKY_BLUE: 'rgb(135, 206, 235)',
            ROAD_COLOR: 'rgb(50, 50, 50)',
            ROAD_MARKING: 'rgb(255, 255, 255)',
            GRASS_COLOR: 'rgb(34, 139, 34)',
            RED: 'rgb(255, 0, 0)',
            BLUE: 'rgb(0, 120, 255)',
            YELLOW: 'rgb(255, 215, 0)',
            BLACK: 'rgb(0, 0, 0)',
            WHITE: 'rgb(255, 255, 255)'
        };

        // Variables del joystick
        let joystickActive = false;
        let joystickPos = { x: 0, y: 0 };
        let joystickMaxDistance = 50;
        let inputDirection = { x: 0, y: 0 };

        // Clase para el jugador
        class PlayerCar {
            constructor() {
                this.width = Math.min(40, canvas.width * 0.06);
                this.height = this.width * 1.75;
                this.reset();
            }
            
            reset() {
                this.x = canvas.width / 2;
                this.y = canvas.height - 100;
                this.speed = 0;
                this.maxSpeed = 12;
                this.acceleration = 0.15;
                this.deceleration = 0.25;
                this.steering = 0;
                this.maxSteering = 4;
                this.color = COLORS.RED;
                this.score = 0;
                this.lives = 3;
            }

            update() {
                // Control con joystick
                const joyX = inputDirection.x;
                const joyY = inputDirection.y;
                
                // Aceleraci√≥n basada en joystick vertical
                if (joyY < -0.2) { // Hacia arriba
                    this.speed = Math.min(this.speed + this.acceleration, this.maxSpeed);
                } else if (joyY > 0.2) { // Hacia abajo
                    this.speed = Math.max(this.speed - this.deceleration * 2, -this.maxSpeed / 2);
                } else {
                    // Desaceleraci√≥n natural
                    if (this.speed > 0) {
                        this.speed = Math.max(this.speed - this.deceleration / 2, 0);
                    } else if (this.speed < 0) {
                        this.speed = Math.min(this.speed + this.deceleration / 2, 0);
                    }
                }

                // Direcci√≥n basada en joystick horizontal
                if (Math.abs(joyX) > 0.2) {
                    this.steering = joyX * this.maxSteering;
                } else {
                    this.steering *= 0.8; // Suavizar retorno
                }

                // Movimiento
                this.x += this.steering * (this.speed / this.maxSpeed);

                // Limitar el coche a la carretera
                const roadWidth = Math.min(300, canvas.width * 0.7);
                const roadLeft = canvas.width / 2 - roadWidth / 2;
                const roadRight = canvas.width / 2 + roadWidth / 2;
                this.x = Math.max(roadLeft + this.width / 2, Math.min(this.x, roadRight - this.width / 2));
            }

            draw() {
                // Dibujar el coche del jugador
                ctx.fillStyle = this.color;
                ctx.fillRect(this.x - this.width / 2, this.y - this.height / 2, this.width, this.height);

                // Detalles del coche
                ctx.fillStyle = COLORS.BLACK;
                ctx.fillRect(this.x - this.width / 2 + 5, this.y - this.height / 2 + 5, this.width - 10, 15);
                ctx.fillRect(this.x - this.width / 2 + 5, this.y + this.height / 2 - 20, this.width - 10, 15);
                
                ctx.fillStyle = COLORS.YELLOW;
                ctx.fillRect(this.x - this.width / 2 - 5, this.y - this.height / 2 + 10, 5, 10);
                ctx.fillRect(this.x + this.width / 2, this.y - this.height / 2 + 10, 5, 10);
                
                ctx.fillStyle = COLORS.RED;
                ctx.fillRect(this.x - this.width / 2 - 5, this.y + this.height / 2 - 20, 5, 10);
                ctx.fillRect(this.x + this.width / 2, this.y + this.height / 2 - 20, 5, 10);
            }
        }

        // Clase para coches enemigos
        class EnemyCar {
            constructor() {
                this.width = Math.min(40, canvas.width * 0.06);
                this.height = this.width * 1.75;
                this.lane = Math.floor(Math.random() * 3) - 1;
                const roadWidth = Math.min(300, canvas.width * 0.7);
                this.x = canvas.width / 2 + this.lane * (roadWidth / 4);
                this.y = -this.height;
                this.speed = Math.random() * 5 + 4;
                this.colors = [COLORS.BLUE, 'rgb(0, 200, 0)', 'rgb(200, 0, 200)', 'rgb(255, 165, 0)'];
                this.color = this.colors[Math.floor(Math.random() * this.colors.length)];
            }

            update() {
                this.y += this.speed;
            }

            draw() {
                ctx.fillStyle = this.color;
                ctx.fillRect(this.x - this.width / 2, this.y - this.height / 2, this.width, this.height);

                ctx.fillStyle = COLORS.BLACK;
                ctx.fillRect(this.x - this.width / 2 + 5, this.y - this.height / 2 + 5, this.width - 10, 15);
                ctx.fillRect(this.x - this.width / 2 + 5, this.y + this.height / 2 - 20, this.width - 10, 15);
            }
        }

        // Sistema de part√≠culas
        class Particle {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.vx = Math.random() * 6 - 3;
                this.vy = Math.random() * 6 - 3;
                this.life = Math.floor(Math.random() * 30) + 30;
                this.colors = [COLORS.WHITE, COLORS.YELLOW, 'rgb(200, 200, 200)'];
                this.color = this.colors[Math.floor(Math.random() * this.colors.length)];
                this.size = Math.random() * 5 + 2;
            }

            update() {
                this.x += this.vx;
                this.y += this.vy;
                this.vy += 0.1; // Gravedad
                this.life--;
                this.size *= 0.95;
            }

            draw() {
                const alpha = Math.min(1, this.life / 50);
                
                ctx.save();
                ctx.globalAlpha = alpha;
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
                ctx.restore();
            }
        }

        // Funci√≥n para dibujar la carretera
        function drawRoad() {
            // Cielo
            ctx.fillStyle = COLORS.SKY_BLUE;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Pasto
            ctx.fillStyle = COLORS.GRASS_COLOR;
            ctx.fillRect(0, canvas.height / 2, canvas.width, canvas.height / 2);

            // Carretera con perspectiva
            const roadWidth = Math.min(300, canvas.width * 0.7);
            const roadTopWidth = Math.min(100, canvas.width * 0.3);

            ctx.fillStyle = COLORS.ROAD_COLOR;
            ctx.beginPath();
            ctx.moveTo(canvas.width / 2 - roadTopWidth / 2, 0);
            ctx.lineTo(canvas.width / 2 + roadTopWidth / 2, 0);
            ctx.lineTo(canvas.width / 2 + roadWidth / 2, canvas.height);
            ctx.lineTo(canvas.width / 2 - roadWidth / 2, canvas.height);
            ctx.closePath();
            ctx.fill();

            // L√≠neas de carretera
            const lineSpacing = 100;
            const lineHeight = 40;
            const lineWidth = Math.min(10, canvas.width * 0.02);

            for (let i = 0; i < canvas.height; i += lineSpacing) {
                const yPos = (i - Date.now() / 12 % lineSpacing) % canvas.height;
                
                ctx.fillStyle = COLORS.ROAD_MARKING;
                ctx.beginPath();
                ctx.moveTo(canvas.width / 2 - lineWidth / 2, yPos);
                ctx.lineTo(canvas.width / 2 - lineWidth / 2, yPos + lineHeight);
                ctx.lineTo(canvas.width / 2 + lineWidth / 2, yPos + lineHeight);
                ctx.lineTo(canvas.width / 2 + lineWidth / 2, yPos);
                ctx.closePath();
                ctx.fill();
            }
        }

        // Variables del juego
        let player = new PlayerCar();
        let enemyCars = [];
        let particles = [];
        let spawnTimer = 0;
        let gameOver = false;
        let turboAvailable = true;
        let turboTimer = 0;
        let highScore = localStorage.getItem('highScore') || 0;

        // Configurar joystick
        function setupJoystick() {
            const container = document.getElementById('joystick-container');
            const knob = document.getElementById('joystick-knob');
            const baseRect = container.getBoundingClientRect();
            
            const baseCenter = {
                x: baseRect.left + baseRect.width / 2,
                y: baseRect.top + baseRect.height / 2
            };
            
            joystickMaxDistance = baseRect.width / 2 - 35;

            // Eventos t√°ctiles
            knob.addEventListener('touchstart', handleTouchStart);
            container.addEventListener('touchmove', handleTouchMove);
            container.addEventListener('touchend', handleTouchEnd);
            
            // Eventos de rat√≥n (para PC)
            knob.addEventListener('mousedown', handleMouseDown);
            document.addEventListener('mousemove', handleMouseMove);
            document.addEventListener('mouseup', handleMouseEnd);

            function handleTouchStart(e) {
                e.preventDefault();
                joystickActive = true;
                updateJoystick(e.touches[0].clientX, e.touches[0].clientY);
            }

            function handleTouchMove(e) {
                if (!joystickActive) return;
                e.preventDefault();
                updateJoystick(e.touches[0].clientX, e.touches[0].clientY);
            }

            function handleTouchEnd() {
                joystickActive = false;
                resetJoystick();
            }

            function handleMouseDown(e) {
                e.preventDefault();
                joystickActive = true;
                updateJoystick(e.clientX, e.clientY);
            }

            function handleMouseMove(e) {
                if (!joystickActive) return;
                e.preventDefault();
                updateJoystick(e.clientX, e.clientY);
            }

            function handleMouseEnd() {
                joystickActive = false;
                resetJoystick();
            }

            function updateJoystick(clientX, clientY) {
                const dx = clientX - baseCenter.x;
                const dy = clientY - baseCenter.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance < joystickMaxDistance) {
                    joystickPos.x = dx;
                    joystickPos.y = dy;
                } else {
                    const angle = Math.atan2(dy, dx);
                    joystickPos.x = Math.cos(angle) * joystickMaxDistance;
                    joystickPos.y = Math.sin(angle) * joystickMaxDistance;
                }
                
                // Actualizar posici√≥n visual del knob
                knob.style.transform = `translate(calc(-50% + ${joystickPos.x}px), calc(-50% + ${joystickPos.y}px))`;
                
                // Calcular direcci√≥n normalizada
                inputDirection.x = joystickPos.x / joystickMaxDistance;
                inputDirection.y = joystickPos.y / joystickMaxDistance;
            }

            function resetJoystick() {
                joystickPos.x = 0;
                joystickPos.y = 0;
                inputDirection.x = 0;
                inputDirection.y = 0;
                knob.style.transform = 'translate(-50%, -50%)';
            }
        }

        // Configurar botones de acci√≥n
        function setupActionButtons() {
            const turboBtn = document.getElementById('turbo-btn');
            const restartBtn = document.getElementById('restart-btn');
            const playAgainBtn = document.getElementById('play-again-btn');
            
            // Turbo
            turboBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                if (turboAvailable && !gameOver) {
                    activateTurbo();
                }
            });
            
            turboBtn.addEventListener('mousedown', (e) => {
                e.preventDefault();
                if (turboAvailable && !gameOver) {
                    activateTurbo();
                }
            });
            
            // Reiniciar
            restartBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                resetGame();
            });
            
            restartBtn.addEventListener('mousedown', (e) => {
                e.preventDefault();
                resetGame();
            });
            
            // Jugar de nuevo
            playAgainBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                resetGame();
                document.getElementById('game-over').style.display = 'none';
            });
            
            playAgainBtn.addEventListener('mousedown', (e) => {
                e.preventDefault();
                resetGame();
                document.getElementById('game-over').style.display = 'none';
            });
        }

        function activateTurbo() {
            player.speed = player.maxSpeed * 1.8;
            turboAvailable = false;
            turboTimer = Date.now();
            
            // Efecto visual
            document.getElementById('turbo-btn').classList.add('active');
            
            // Part√≠culas de turbo
            for (let i = 0; i < 40; i++) {
                particles.push(new Particle(player.x, player.y + player.height / 2));
            }
        }

        function resetGame() {
            player.reset();
            enemyCars = [];
            particles = [];
            gameOver = false;
            turboAvailable = true;
            turboTimer = 0;
            spawnTimer = 0;
            document.getElementById('turbo-btn').classList.remove('active');
            document.getElementById('game-over').style.display = 'none';
        }

        function updateHUD() {
            document.getElementById('speed').textContent = `${Math.abs(Math.floor(player.speed * 25))} km/h`;
            document.getElementById('score').textContent = `${player.score} pts`;
            document.getElementById('lives').textContent = player.lives;
            
            // Actualizar turbo
            if (!turboAvailable) {
                const timePassed = Date.now() - turboTimer;
                const rechargeTime = 5000;
                const percent = Math.min(100, (timePassed / rechargeTime) * 100);
                
                document.getElementById('turbo-fill').style.width = `${percent}%`;
                document.getElementById('turbo-text').textContent = `${Math.floor(5 - timePassed/1000)}s`;
                
                if (timePassed >= rechargeTime) {
                    turboAvailable = true;
                    document.getElementById('turbo-btn').classList.remove('active');
                    document.getElementById('turbo-text').textContent = 'LISTO';
                    document.getElementById('turbo-fill').style.width = '100%';
                }
            }
        }

        // Bucle principal del juego
        function gameLoop() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (!gameOver) {
                // Actualizar jugador
                player.update();
                
                // Generar enemigos
                spawnTimer++;
                if (spawnTimer >= 45) {
                    enemyCars.push(new EnemyCar());
                    spawnTimer = 0;
                    
                    // Aumentar dificultad con el tiempo
                    if (player.score > 1000) {
                        enemyCars.push(new EnemyCar());
                    }
                }
                
                // Actualizar enemigos
                for (let i = enemyCars.length - 1; i >= 0; i--) {
                    const enemy = enemyCars[i];
                    enemy.update();
                    
                    // Detectar colisiones
                    if (Math.abs(player.x - enemy.x) < (player.width + enemy.width) / 2 &&
                        Math.abs(player.y - enemy.y) < (player.height + enemy.height) / 2) {
                        player.lives--;
                        enemyCars.splice(i, 1);
                        
                        // Efecto de colisi√≥n
                        for (let j = 0; j < 60; j++) {
                            particles.push(new Particle(enemy.x, enemy.y));
                        }
                        
                        if (player.lives <= 0) {
                            gameOver = true;
                            if (player.score > highScore) {
                                highScore = player.score;
                                localStorage.setItem('highScore', highScore);
                            }
                            document.getElementById('final-score').textContent = player.score;
                            document.getElementById('high-score').textContent = highScore;
                            document.getElementById('game-over').style.display = 'flex';
                        }
                    } else if (enemy.y > canvas.height + enemy.height) {
                        enemyCars.splice(i, 1);
                        player.score += 10;
                    }
                }
                
                // Actualizar part√≠culas
                for (let i = particles.length - 1; i >= 0; i--) {
                    particles[i].update();
                    if (particles[i].life <= 0 || particles[i].size <= 0.5) {
                        particles.splice(i, 1);
                    }
                }
            }
            
            // Dibujar
            drawRoad();
            enemyCars.forEach(enemy => enemy.draw());
            particles.forEach(particle => particle.draw());
            player.draw();
            
            // Actualizar HUD
            updateHUD();
            
            requestAnimationFrame(gameLoop);
        }

        // Inicializar el juego
        setupJoystick();
        setupActionButtons();
        gameLoop();
        
        // Mensaje inicial
        setTimeout(() => {
            if (confirm("¬°Bienvenido a Carreras 3D Extremo!\n\n‚Ä¢ Usa el joystick circular para moverte\n‚Ä¢ Toca TURBO para acelerar\n‚Ä¢ Evita los coches enemigos\n\n¬øListo para jugar?")) {
                // Juego ya iniciado
            }
        }, 500);
    </script>
</body>
</html>